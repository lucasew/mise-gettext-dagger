#!/usr/bin/env bash
set -euo pipefail

# Configuration
BUILDENV_VERSION="0.0.1"
BUILDENV_IMAGE="ghcr.io/actions-precompiled/buildenv"
TARGETS="${TARGETS:-linux-amd64 linux-aarch64 windows-amd64}"
MIRROR="${GETTEXT_MIRROR:-https://mirrors.ocf.berkeley.edu/gnu/gettext}"

# Parse command line arguments for versions, or auto-detect
# shellcheck disable=SC2206
versions_to_build=($*)

function build_target {
    local VERSION="$1"
    local TARGET="$2"
    local OUTPUT_DIR="$3"

    echo ""
    echo "Building ${VERSION} for ${TARGET}..."

    # Run CMake build in Docker container
    docker run --rm \
        -v "$(pwd):/src:ro" \
        -v "${OUTPUT_DIR}:/out" \
        -e GETTEXT_VERSION="${VERSION}" \
        -e BUILD_TARGET="${TARGET}" \
        -e GETTEXT_MIRROR="${MIRROR}" \
        -w /src \
        "${BUILDENV_IMAGE}:${BUILDENV_VERSION}" \
        sh -c 'cmake -S . -B /tmp/cmake-build && cmake --build /tmp/cmake-build'
}

function build_release {
    VERSION="$1"; shift

    echo ""
    echo "========================================"
    echo "Building gettext version ${VERSION}"
    echo "========================================"

    # Clean previous build artifacts for this version
    rm -rf target/"${VERSION}"
    mkdir -p target/"${VERSION}"

    # Pull buildenv container once
    echo "Pulling ${BUILDENV_IMAGE}:${BUILDENV_VERSION}..."
    docker pull "${BUILDENV_IMAGE}:${BUILDENV_VERSION}"

    # Build for each target platform
    for TARGET in ${TARGETS}; do
        OUTPUT_DIR="$(pwd)/target/${VERSION}"
        build_target "${VERSION}" "${TARGET}" "${OUTPUT_DIR}"
    done

    echo ""
    echo "Built artifacts for ${VERSION}:"
    ls -lh target/"${VERSION}"
    echo ""

    # Skip release creation if LOCAL_BUILD is set
    if [[ -v LOCAL_BUILD ]]; then
        echo "LOCAL_BUILD mode - skipping GitHub release"
        return 0
    fi

    # Create GitHub release and upload artifacts
    echo "Creating GitHub release ${VERSION}..."
    echo "" | gh release create "${VERSION}" --target empty || true # idempotency

    echo "Uploading artifacts to release ${VERSION}..."
    gh release upload "${VERSION}" --clobber target/"${VERSION}"/*

    echo "✓ Successfully built and uploaded release ${VERSION}"
}

# Auto-detect versions to build if none specified
if [ "${#versions_to_build[@]}" -eq 0 ]; then
    echo "Auto-detecting versions to build..."
    echo ""

    # Get list of available versions
    echo "Fetching available upstream versions..."
    ./scripts/list_versions.py | sort -V > upstream_versions.txt
    UPSTREAM_COUNT=$(wc -l < upstream_versions.txt)
    echo "  Found ${UPSTREAM_COUNT} upstream versions"

    # Get list of already released versions
    echo "Fetching already released versions..."
    gh release list --json tagName | jq '.[].tagName' -r | sort -V > released_versions.txt
    RELEASED_COUNT=$(wc -l < released_versions.txt)
    echo "  Found ${RELEASED_COUNT} released versions"

    # Find versions that need to be built (versions in upstream but not in released)
    echo "Comparing versions..."
    # shellcheck disable=SC2207
    versions_to_build=($(comm -23 upstream_versions.txt released_versions.txt))

    # Clean up temp files only if not in DRY_RUN mode
    if [[ ! -v DRY_RUN ]]; then
        rm -f upstream_versions.txt released_versions.txt
    else
        echo ""
        echo "Temporary comparison files preserved for inspection:"
        echo "  - upstream_versions.txt (${UPSTREAM_COUNT} versions)"
        echo "  - released_versions.txt (${RELEASED_COUNT} versions)"
    fi
fi

# Show what will be built
echo ""
echo "========================================"
if [ "${#versions_to_build[@]}" -eq 0 ]; then
    echo "No versions to build!"
    echo "========================================"
    echo ""
    echo "All upstream versions have already been released."
    if [[ -v DRY_RUN ]]; then
        echo "Check upstream_versions.txt and released_versions.txt for details."
    fi
    exit 0
fi

echo "Versions to be built: ${#versions_to_build[@]}"
echo "========================================"
for version in "${versions_to_build[@]}"; do
    printf "  - %s (targets: %s)\n" "$version" "${TARGETS}"
done
echo ""

if [[ -v DRY_RUN ]]; then
    echo "DRY_RUN mode - exiting without building"
    echo "Run without DRY_RUN=1 to perform the actual build."
    exit 0
fi

# Build each version
for version in "${versions_to_build[@]}"; do
    build_release "$version"
done

echo ""
echo "========================================"
echo "✓ All releases built successfully!"
echo "========================================"
